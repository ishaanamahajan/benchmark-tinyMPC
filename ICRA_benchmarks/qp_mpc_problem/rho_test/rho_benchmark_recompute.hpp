#pragma once
#include <Arduino.h>

// Dimensions
#define BENCH_NX 12
#define BENCH_NU 4

// Result structure
struct RhoBenchmarkResult {
    uint32_t time_us;
    float initial_rho;
    float final_rho;
};

// System matrices
const float A[BENCH_NX][BENCH_NX] = {
    {1.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0039f, -0.0000f, 0.0200f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, -0.0000f},
    {0.0000f, 1.0000f, 0.0000f, -0.0039f, 0.0000f, 0.0000f, 0.0000f, 0.0200f, 0.0000f, -0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 1.0000f, 0.0000f, -0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0200f, 0.0000f, -0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 1.0000f, 0.0000f, -0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0100f, 0.0000f, -0.0000f},
    {0.0000f, 0.0000f, 0.0000f, -0.0000f, 1.0000f, -0.0000f, 0.0000f, 0.0000f, 0.0000f, -0.0000f, 0.0100f, -0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 1.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0100f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.3924f, -0.0000f, 1.0000f, 0.0000f, 0.0000f, -0.0000f, 0.0020f, -0.0000f},
    {0.0000f, 0.0000f, 0.0000f, -0.3924f, 0.0000f, 0.0000f, 0.0000f, 1.0000f, 0.0000f, -0.0020f, -0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, -0.0000f, 0.0000f, 0.0000f, 0.0000f, 1.0000f, 0.0000f, -0.0000f, -0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 1.0000f, 0.0000f, -0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, -0.0000f, 1.0000f, -0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 1.0000f}
};

const float B[BENCH_NX][BENCH_NU] = {
    {-0.0000f, 0.0000f, 0.0000f, -0.0000f},
    {0.0000f, 0.0000f, -0.0000f, -0.0000f},
    {0.0008f, 0.0008f, 0.0008f, 0.0008f},
    {-0.0275f, -0.0303f, 0.0276f, 0.0303f},
    {-0.0277f, 0.0304f, 0.0278f, -0.0305f},
    {0.0020f, -0.0007f, -0.0028f, 0.0015f},
    {-0.0036f, 0.0040f, 0.0036f, -0.0040f},
    {0.0036f, 0.0040f, -0.0036f, -0.0040f},
    {0.0841f, 0.0841f, 0.0841f, 0.0841f},
    {-5.5071f, -6.0647f, 5.5133f, 6.0585f},
    {-5.5341f, 6.0856f, 5.5514f, -6.1028f},
    {0.3950f, -0.1445f, -0.5569f, 0.3064f}
};

const float Q[BENCH_NX][BENCH_NX] = {
    {100.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 100.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 100.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 4.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 4.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 400.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 4.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 4.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 4.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 2.0408f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 2.0408f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 0.0000f, 25.0000f}
};

const float R[BENCH_NU][BENCH_NU] = {
    {229.0000f, 0.0000f, 0.0000f, 0.0000f},
    {0.0000f, 229.0000f, 0.0000f, 0.0000f},
    {0.0000f, 0.0000f, 229.0000f, 0.0000f},
    {0.0000f, 0.0000f, 0.0000f, 229.0000f}
};

// Cache matrices declarations (defined as static in cpp)
extern float Kinf[BENCH_NU][BENCH_NX];
extern float Pinf[BENCH_NX][BENCH_NX];
extern float C1[BENCH_NU][BENCH_NU];
extern float C2[BENCH_NX][BENCH_NX];


// External dependencies needed by benchmark
extern float x_prev[BENCH_NX];
extern float u_prev[BENCH_NU];
extern float z_prev[BENCH_NX];
extern const float A_stacked[BENCH_NX + BENCH_NU][BENCH_NX + BENCH_NU];
extern const float q[BENCH_NX + BENCH_NU];

// Function declarations
void update_cache_taylor(float new_rho, float old_rho);
void initialize_benchmark_cache();  // This needs to be implemented
void benchmark_rho_adaptation(float pri_res, float dual_res, RhoBenchmarkResult* result);\



const float PINF_INIT[12][12] = {
    {74092.187704f, -73.167319f, 0.000000f, 198.053342f, 78082.549386f, 1717.656003f, 26348.957464f, -44.979013f, 0.000000f, 7.184539f, 399.820082f, 213.830097f},
    {-73.167319f, 73964.909547f, -0.000000f, -77730.404405f, -197.999696f, -686.738633f, -44.969404f, 26269.155532f, -0.000000f, -387.712050f, -7.186499f, -85.452259f},
    {0.000000f, -0.000000f, 44963.622514f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, 6235.729084f, 0.000000f, 0.000000f, 0.000000f},
    {198.053342f, -77730.404405f, 0.000000f, 295376.035129f, 910.998615f, 4979.087349f, 149.190105f, -54213.403856f, 0.000000f, 1507.510149f, 49.618732f, 687.275807f},
    {78082.549386f, -197.999696f, 0.000000f, 910.998615f, 297086.229647f, 12449.458845f, 54486.369572f, -149.178137f, 0.000000f, 49.618853f, 1600.826569f, 1718.550470f},
    {1717.656003f, -686.738633f, 0.000000f, 4979.087349f, 12449.458845f, 249846.316019f, 1575.992749f, -630.228271f, 0.000000f, 348.342573f, 870.953406f, 14433.220501f},
    {26348.957464f, -44.969404f, 0.000000f, 149.190105f, 54486.369572f, 1575.992749f, 15386.757218f, -30.020107f, 0.000000f, 6.160320f, 283.309542f, 196.304757f},
    {-44.979013f, 26269.155532f, -0.000000f, -54213.403856f, -149.178137f, -630.228271f, -30.020107f, 15332.380946f, -0.000000f, -272.368631f, -6.160959f, -78.483363f},
    {0.000000f, -0.000000f, 6235.729084f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, 3312.994426f, 0.000000f, 0.000000f, 0.000000f},
    {7.184539f, -387.712050f, -0.000000f, 1507.510149f, 49.618853f, 348.342573f, 6.160320f, -272.368631f, 0.000000f, 185.041879f, 6.126061f, 92.499883f},
    {399.820082f, -7.186499f, 0.000000f, 49.618732f, 1600.826569f, 870.953406f, 283.309542f, -6.160959f, 0.000000f, 6.126061f, 197.178200f, 231.262934f},
    {213.830097f, -85.452259f, 0.000000f, 687.275807f, 1718.550470f, 14433.220501f, 196.304757f, -78.483363f, 0.000000f, 92.499883f, 231.262934f, 3894.405009f},
};
const float C1_INIT[4][4] = {
    {0.001228f, 0.000008f, 0.001186f, 0.000009f},
    {0.000008f, 0.001223f, 0.000011f, 0.001189f},
    {0.001186f, 0.000011f, 0.001222f, 0.000013f},
    {0.000009f, 0.001189f, 0.000013f, 0.001220f},
};
const float C2_INIT[12][12] = {
    {0.999988f, -0.000000f, 0.000000f, 0.000021f, -0.019007f, 0.001094f, -0.002486f, -0.000003f, 0.000000f, 0.004264f, -3.801469f, 0.218865f},
    {-0.000000f, 0.999988f, -0.000000f, 0.019009f, -0.000021f, -0.000437f, -0.000003f, -0.002486f, -0.000000f, 3.801852f, -0.004220f, -0.087345f},
    {-0.000000f, -0.000000f, 0.995404f, 0.000000f, -0.000000f, 0.000000f, -0.000000f, -0.000000f, -0.459639f, 0.000000f, -0.000000f, 0.000000f},
    {0.000000f, -0.003873f, 0.000000f, 0.922624f, 0.000081f, 0.001660f, 0.000011f, -0.382279f, 0.000000f, -15.475193f, 0.016263f, 0.331965f},
    {0.003873f, -0.000000f, 0.000000f, 0.000082f, 0.922605f, 0.004161f, 0.382277f, -0.000011f, 0.000000f, 0.016384f, -15.478918f, 0.832192f},
    {0.000000f, -0.000000f, 0.000000f, 0.000245f, 0.000615f, 0.995117f, 0.000080f, -0.000032f, 0.000000f, 0.049073f, 0.122914f, -0.976627f},
    {0.019991f, -0.000000f, 0.000000f, 0.000015f, -0.013626f, 0.000769f, 0.998218f, -0.000002f, 0.000000f, 0.003037f, -2.725219f, 0.153866f},
    {-0.000000f, 0.019991f, -0.000000f, 0.013625f, -0.000015f, -0.000307f, -0.000002f, 0.998218f, -0.000000f, 2.724958f, -0.003010f, -0.061389f},
    {0.000000f, -0.000000f, 0.017587f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, -0.000000f, 0.758742f, -0.000000f, -0.000000f, 0.000000f},
    {0.000000f, -0.000010f, 0.000000f, 0.004679f, 0.000007f, 0.000099f, 0.000001f, -0.001266f, 0.000000f, -0.064134f, 0.001439f, 0.019701f},
    {0.000010f, -0.000000f, 0.000000f, 0.000007f, 0.004682f, 0.000247f, 0.001266f, -0.000001f, 0.000000f, 0.001444f, -0.063588f, 0.049403f},
    {0.000000f, -0.000000f, 0.000000f, 0.000029f, 0.000073f, 0.008722f, 0.000010f, -0.000004f, 0.000000f, 0.005877f, 0.014697f, 0.744465f},
};
const float KINF_INIT[4][12] = {
    {-0.216731f, 0.190402f, 1.366579f, -0.848711f, -1.066524f, -3.009834f, -0.164837f, 0.140262f, 0.717299f, -0.068030f, -0.097495f, -0.792505f},
    {0.201444f, 0.138892f, 1.366579f, -0.491749f, 1.003969f, 3.010949f, 0.153864f, 0.095762f, 0.717299f, -0.024156f, 0.093195f, 0.792117f},
    {0.126087f, -0.154187f, 1.366579f, 0.554307f, 0.330238f, -3.012637f, 0.080966f, -0.106738f, 0.717299f, 0.028459f, -0.001447f, -0.791015f},
    {-0.110799f, -0.175107f, 1.366579f, 0.786153f, -0.267683f, 3.011522f, -0.069994f, -0.129287f, 0.717299f, 0.063727f, 0.005747f, 0.791402f},
};