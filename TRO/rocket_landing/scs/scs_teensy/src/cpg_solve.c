
/*
Auto-generated by CVXPYgen on July 21, 2025 at 20:51:26.
Content: Function definitions.
*/

#include "cpg_solve.h"
#include "cpg_workspace.h"

static cpg_int i;
static cpg_int j;

// Update user-defined parameters
void cpg_update_param3(cpg_int idx, cpg_float val){
  cpg_params_vec[idx+0] = val;
  Canon_Outdated.c = 1;
}

void cpg_update_param1(cpg_int idx, cpg_float val){
  cpg_params_vec[idx+573] = val;
  Canon_Outdated.b = 1;
}

// Map user-defined to canonical parameters
void cpg_canonicalize_c(){
  for(i=0; i<1209; i++){
    Canon_Params.c[i] = 0;
    for(j=canon_c_map.p[i]; j<canon_c_map.p[i+1]; j++){
      Canon_Params.c[i] += canon_c_map.x[j]*cpg_params_vec[canon_c_map.i[j]];
    }
  }
}

void cpg_canonicalize_b(){
  for(i=0; i<1587; i++){
    Canon_Params.b[i] = 0;
    for(j=canon_b_map.p[i]; j<canon_b_map.p[i+1]; j++){
      Canon_Params.b[i] += canon_b_map.x[j]*cpg_params_vec[canon_b_map.i[j]];
    }
  }
}

// Retrieve dual solution in terms of user-defined constraints
void cpg_retrieve_dual(){
  CPG_Dual.d64 = scs_y[957];
  CPG_Dual.d65 = scs_y[958];
  CPG_Dual.d66 = scs_y[959];
  CPG_Dual.d67 = scs_y[960];
  CPG_Dual.d68 = scs_y[961];
  CPG_Dual.d69 = scs_y[962];
  CPG_Dual.d70 = scs_y[963];
  CPG_Dual.d71 = scs_y[964];
  CPG_Dual.d72 = scs_y[965];
  CPG_Dual.d73 = scs_y[966];
  CPG_Dual.d74 = scs_y[967];
  CPG_Dual.d75 = scs_y[968];
  CPG_Dual.d76 = scs_y[969];
  CPG_Dual.d77 = scs_y[970];
  CPG_Dual.d78 = scs_y[971];
  CPG_Dual.d79 = scs_y[972];
  CPG_Dual.d80 = scs_y[973];
  CPG_Dual.d81 = scs_y[974];
  CPG_Dual.d82 = scs_y[975];
  CPG_Dual.d83 = scs_y[976];
  CPG_Dual.d84 = scs_y[977];
  CPG_Dual.d85 = scs_y[978];
  CPG_Dual.d86 = scs_y[979];
  CPG_Dual.d87 = scs_y[980];
  CPG_Dual.d88 = scs_y[981];
  CPG_Dual.d89 = scs_y[982];
  CPG_Dual.d90 = scs_y[983];
  CPG_Dual.d91 = scs_y[984];
  CPG_Dual.d92 = scs_y[985];
  CPG_Dual.d93 = scs_y[986];
  CPG_Dual.d94 = scs_y[987];
  CPG_Dual.d95 = scs_y[988];
  CPG_Dual.d96 = scs_y[989];
  CPG_Dual.d97 = scs_y[990];
  CPG_Dual.d98 = scs_y[991];
  CPG_Dual.d99 = scs_y[992];
  CPG_Dual.d100 = scs_y[993];
  CPG_Dual.d101 = scs_y[994];
  CPG_Dual.d102 = scs_y[995];
  CPG_Dual.d103 = scs_y[996];
  CPG_Dual.d104 = scs_y[997];
  CPG_Dual.d105 = scs_y[998];
  CPG_Dual.d106 = scs_y[999];
  CPG_Dual.d107 = scs_y[1000];
  CPG_Dual.d108 = scs_y[1001];
  CPG_Dual.d109 = scs_y[1002];
  CPG_Dual.d110 = scs_y[1003];
  CPG_Dual.d111 = scs_y[1004];
  CPG_Dual.d112 = scs_y[1005];
  CPG_Dual.d113 = scs_y[1006];
  CPG_Dual.d114 = scs_y[1007];
  CPG_Dual.d115 = scs_y[1008];
  CPG_Dual.d116 = scs_y[1009];
  CPG_Dual.d117 = scs_y[1010];
  CPG_Dual.d118 = scs_y[1011];
  CPG_Dual.d119 = scs_y[1012];
  CPG_Dual.d120 = scs_y[1013];
  CPG_Dual.d121 = scs_y[1014];
  CPG_Dual.d122 = scs_y[1015];
  CPG_Dual.d123 = scs_y[1016];
  CPG_Dual.d124 = scs_y[1017];
  CPG_Dual.d125 = scs_y[1018];
  CPG_Dual.d126 = scs_y[1019];
}

// Retrieve solver info
void cpg_retrieve_info(){
  CPG_Info.obj_val = (Scs_Info.pobj);
  CPG_Info.iter = Scs_Info.iter;
  CPG_Info.status = Scs_Info.status;
  CPG_Info.pri_res = Scs_Info.res_pri;
  CPG_Info.dua_res = Scs_Info.res_dual;
}

// Solve via canonicalization, canonical solve, retrieval
void cpg_solve(){
  // Canonicalize if necessary
  if (Canon_Outdated.c) {
    cpg_canonicalize_c();
  }
  if (Canon_Outdated.b) {
    cpg_canonicalize_b();
  }
  if (!Scs_Work ) {
    Scs_Work = scs_init(&Scs_D, &Scs_K, &Canon_Settings);
  } else {
    if (Canon_Outdated.b && Canon_Outdated.c) {
      scs_update(Scs_Work, Canon_Params.b, Canon_Params.c);
    } else {
      if (Canon_Outdated.b) {
        scs_update(Scs_Work, Canon_Params.b, SCS_NULL);
      }
      if (Canon_Outdated.c) {
        scs_update(Scs_Work, SCS_NULL, Canon_Params.c);
      }
    }
  }
  // Solve with SCS
  scs_solve(Scs_Work, &Scs_Sol, &Scs_Info, (Scs_Work && Canon_Settings.warm_start));
  // Retrieve results
  cpg_retrieve_dual();
  cpg_retrieve_info();
  // Reset flags for outdated canonical parameters
  Canon_Outdated.c = 0;
  Canon_Outdated.b = 0;
}

// Update solver settings
void cpg_set_solver_default_settings(){
  scs_set_default_settings(&Canon_Settings);
}

void cpg_set_solver_normalize(cpg_int normalize_new){
  Canon_Settings.normalize = normalize_new;
}

void cpg_set_solver_scale(cpg_float scale_new){
  Canon_Settings.scale = scale_new;
}

void cpg_set_solver_adaptive_scale(cpg_int adaptive_scale_new){
  Canon_Settings.adaptive_scale = adaptive_scale_new;
}

void cpg_set_solver_rho_x(cpg_float rho_x_new){
  Canon_Settings.rho_x = rho_x_new;
}

void cpg_set_solver_max_iters(cpg_int max_iters_new){
  Canon_Settings.max_iters = max_iters_new;
}

void cpg_set_solver_eps_abs(cpg_float eps_abs_new){
  Canon_Settings.eps_abs = eps_abs_new;
}

void cpg_set_solver_eps_rel(cpg_float eps_rel_new){
  Canon_Settings.eps_rel = eps_rel_new;
}

void cpg_set_solver_eps_infeas(cpg_float eps_infeas_new){
  Canon_Settings.eps_infeas = eps_infeas_new;
}

void cpg_set_solver_alpha(cpg_float alpha_new){
  Canon_Settings.alpha = alpha_new;
}

void cpg_set_solver_time_limit_secs(cpg_float time_limit_secs_new){
  Canon_Settings.time_limit_secs = time_limit_secs_new;
}

void cpg_set_solver_verbose(cpg_int verbose_new){
  Canon_Settings.verbose = verbose_new;
}

void cpg_set_solver_warm_start(cpg_int warm_start_new){
  Canon_Settings.warm_start = warm_start_new;
}

void cpg_set_solver_acceleration_lookback(cpg_int acceleration_lookback_new){
  Canon_Settings.acceleration_lookback = acceleration_lookback_new;
}

void cpg_set_solver_acceleration_interval(cpg_int acceleration_interval_new){
  Canon_Settings.acceleration_interval = acceleration_interval_new;
}

void cpg_set_solver_write_data_filename(const char* write_data_filename_new){
  Canon_Settings.write_data_filename = write_data_filename_new;
}

void cpg_set_solver_log_csv_filename(const char* log_csv_filename_new){
  Canon_Settings.log_csv_filename = log_csv_filename_new;
}
